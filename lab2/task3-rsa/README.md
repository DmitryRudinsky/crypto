# Task 3: RSA Encryption Service

## Описание

Объектный сервис для шифрования и дешифрования данных алгоритмом RSA с вложенным генератором ключей. Реализована защита от атак Ферма и Винера.

## Архитектура

### RSAService

Основной сервис для работы с RSA. Содержит:

**Вложенное перечисление PrimalityTestType:**
- `FERMAT` - тест Ферма
- `SOLOVAY_STRASSEN` - тест Соловея-Штрассена  
- `MILLER_RABIN` - тест Миллера-Рабина

**Вложенные классы для ключей:**
- `PublicKey(BigInteger n, BigInteger e)` - открытый ключ
- `PrivateKey(BigInteger n, BigInteger d)` - закрытый ключ
- `KeyPair(PublicKey, PrivateKey)` - пара ключей

**Вложенный класс KeyGenerator:**

Генератор ключей RSA с защитой от атак.

**Конструктор:** `KeyGenerator(PrimalityTestType testType, double minProbability, int bitLength)`
- `testType` - тип теста простоты для проверки p и q
- `minProbability` - минимальная вероятность простоты [0.5, 1)
- `bitLength` - битовая длина генерируемых простых чисел

**Метод:** `generateKeyPair()` → `KeyPair`

### Конструктор RSAService

`RSAService(PrimalityTestType testType, double minProbability, int bitLength)`

Параметры делегируются вложенному KeyGenerator. При создании автоматически генерируется первая ключевая пара.

## Алгоритм генерации ключей

### 1. Генерация простых чисел
- Генерация случайного нечетного числа заданной битовой длины
- Проверка на простоту выбранным тестом с заданной вероятностью
- Повторение до получения простого числа

### 2. Защита от атаки Ферма
**Проблема:** если |p - q| мала, то n можно разложить методом Ферма

**Решение:** проверка условия |p - q| > (p + q) / 3

Если условие не выполнено, q регенерируется.

### 3. Вычисление параметров
- `n = p × q` - модуль
- `φ(n) = (p - 1) × (q - 1)` - функция Эйлера
- `e` - открытая экспонента (обычно 65537), взаимно простая с φ(n)
- `d` - закрытая экспонента: `d ≡ e^(-1) (mod φ(n))`

Вычисление d через расширенный алгоритм Евклида.

### 4. Защита от атаки Винера
**Проблема:** если d < n^(1/4), то d можно найти через цепные дроби

**Решение:** проверка условия d > n^(1/4)

Если условие не выполнено, e регенерируется.

## API

### Управление ключами
```java
PublicKey getPublicKey()
PrivateKey getPrivateKey()
void regenerateKeyPair()
```

### Шифрование/дешифрование BigInteger
```java
BigInteger encrypt(BigInteger message)
BigInteger decrypt(BigInteger ciphertext)
BigInteger encrypt(BigInteger message, PublicKey publicKey)
BigInteger decrypt(BigInteger ciphertext, PrivateKey privateKey)
```

**Алгоритм:**
- Шифрование: `c = m^e mod n`
- Дешифрование: `m = c^d mod n`

**Ограничение:** сообщение должно быть в диапазоне [0, n)

### Шифрование/дешифрование byte[]
```java
byte[] encrypt(byte[] data)
byte[] decrypt(byte[] data)
byte[] encrypt(byte[] data, PublicKey publicKey)
byte[] decrypt(byte[] data, PrivateKey privateKey)
```

Преобразует байтовый массив в BigInteger и применяет числовое шифрование.

**Ограничение:** размер данных не должен превышать размер модуля n

## Тесты

`RSAServiceTest.java` - 30 тестов, покрывающих все аспекты реализации:

**testBasicEncryptionDecryption** (2 теста):
- Проверка, что зашифрованное сообщение отличается от оригинала
- Проверка корректности расшифровки

**testBigIntegerMessages** (7 тестов):
- Шифрование/дешифрование чисел: 0, 1, 2, 100, 12345, 999999, 123456789012345
- Проверка корректности для всех значений

**testByteArrayMessages** (4 теста):
- Шифрование/дешифрование текстовых строк: "Hello", "RSA", "Test123", "Cryptography"
- Проверка побайтового совпадения

**testKeyRegeneration** (3 теста):
- Проверка, что новые ключи отличаются от старых
- Проверка работоспособности после первой регенерации
- Проверка работоспособности после второй регенерации

**testDifferentPrimalityTests** (3 теста):
- Проверка работы с тестом Ферма
- Проверка работы с тестом Соловея-Штрассена
- Проверка работы с тестом Миллера-Рабина

**testDifferentKeySizes** (6 тестов):
- Проверка генерации ключей размером 128, 256, 512 бит
- Для каждого размера: проверка битовой длины n и корректности шифрования

**testPublicPrivateKeyUsage** (1 тест):
- Проверка явного использования публичного и приватного ключей

**testEncryptionWithDifferentKeys** (4 теста):
- Проверка работы двух независимых сервисов
- Проверка, что разные ключи дают разные шифртексты
- Проверка кросс-сервисного шифрования с совпадающими ключами

Все тесты проходят успешно.

## Демонстрация

`Demo.java` - комплексная демонстрация возможностей:

**1. Создание сервиса**
- Инициализация с тестом Миллера-Рабина, битовой длиной 512, вероятностью 0.999
- Вывод сгенерированных ключей (n, e, d)

**2. Шифрование BigInteger**
- Демонстрация на числах: 42, 12345, 999999, 123456789012345
- Вывод оригинала, зашифрованного и расшифрованного значений
- Проверка совпадения

**3. Шифрование byte[]**
- Демонстрация на строках: "Hello, RSA!", "Cryptography is awesome", "12345"
- Вывод в шестнадцатеричном формате
- Проверка совпадения

**4. Регенерация ключей**
- Вывод старого и нового ключей
- Демонстрация различия
- Проверка работы с новыми ключами

**5. Сравнение тестов простоты**
- Создание сервисов с каждым из трех тестов
- Демонстрация работоспособности всех вариантов

**6. Большие сообщения**
- Создание сервиса с 1024-битными ключами
- Шифрование большого числа 987654321098765432109876543210

## Безопасность

### Защита от атаки Ферма
Атака основана на том, что если p и q близки, то n ≈ (p+q)²/4, и можно найти p и q через √n.

**Реализованная защита:** |p - q| > (p + q) / 3

Это гарантирует достаточную разницу между простыми числами.

### Защита от атаки Винера
Атака использует цепные дроби для нахождения d, если d < n^(1/4).

**Реализованная защита:** d > n^(1/4)

Если условие не выполнено, выбирается другая открытая экспонента e.

## Запуск

```bash
./run-demo.sh   # сборка + запуск демонстрации
./run-tests.sh  # сборка + запуск тестов
./build.sh      # только сборка
```

## Структура

```
lib-src/
  NumberTheoryService.java      - операции теории чисел
  PrimalityTest.java            - интерфейс теста простоты
  AbstractPrimalityTest.java    - базовый класс
  FermatTest.java               - тест Ферма
  SolovayStrassenTest.java      - тест Соловея-Штрассена
  MillerRabinTest.java          - тест Миллера-Рабина

src/
  RSAService.java  - основной сервис RSA
  Demo.java        - демонстрация

test/
  RSAServiceTest.java  - тесты

out/
  production/  - скомпилированные классы
  test/        - скомпилированные тесты
```

## Технические детали

### Выбор открытой экспоненты e
1. По умолчанию используется e = 65537 (стандартное значение)
2. Проверяется взаимная простота с φ(n): gcd(e, φ(n)) = 1
3. Если условие не выполнено, начинается с e = 3 и ищется следующее подходящее нечетное число

### Вычисление закрытой экспоненты d
Используется расширенный алгоритм Евклида для решения:
```
e × d ≡ 1 (mod φ(n))
```
Результат нормализуется к положительному значению в диапазоне [0, φ(n))

### Вычисление квадратного корня
Для проверки условия Винера реализован метод бинарного поиска для вычисления √n и ⁴√n.

